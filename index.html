<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"famer.me","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="My Space">
<meta property="og:url" content="https://famer.me/index.html">
<meta property="og:site_name" content="My Space">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ming yang">
<meta property="article:tag" content="fullstack">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="rust">
<meta property="article:tag" content="scala">
<meta property="article:tag" content="nodejs">
<meta property="article:tag" content="typescript">
<meta property="article:tag" content="scheme">
<meta property="article:tag" content="SICP">
<meta property="article:tag" content="risc-v">
<meta property="article:tag" content="functional programming">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://famer.me/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>My Space</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1RGPQ0EFYL"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-1RGPQ0EFYL","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">My Space</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ming yang"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">ming yang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/mingyang91" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;mingyang91" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2026/02/06/vibe-coding-one-year-reflection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/02/06/vibe-coding-one-year-reflection/" class="post-title-link" itemprop="url">Vibe Coding 一年实践后的冷思考</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2026-02-06 13:44:21 / Modified: 20:29:54" itemprop="dateCreated datePublished" datetime="2026-02-06T13:44:21+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言">前言</h1>
<p>最近一年我在 Google/Anthropic/OpenAI 三家烧了超过 1 万美金的 token
账单。所以本文内容基于 opus4.6、codex-5.3-xhigh、gemini3-pro
等最强模型不限量使用所表现出来的编码能力进行评价。</p>
<h1 id="现象agent-的信任危机">现象：Agent 的信任危机</h1>
<p>就好像保健品销售拿着他的《大数据量子 AI
生物磁场治疗仪》，忽悠我说这台原价 20 万、现在活动价 8 万 8
的仪器，可以彻底根治我的颈椎病腰椎病高血压糖尿病，还能逆转我的动脉血管粥样硬化、冠心病、阳痿早泄等等</p>
<p>Agent 编程现在就是这么个状态。</p>
<p>Agent 给我一堆 emoji
庆祝刚才生成的七八万行屎山通过了全部测试用例，告诉我可以替换生产环境了。你信吗？</p>
<p>假设你是一位项目 leader，你最靠谱的组员同事，交给他的开发任务 80%
可以在预期时间内高质量交付。这位同事拿头给你保证下周就可以上线，那么你大概率能信任他最迟下下周也搞定了。但是
agent 给你保证现在质量和完成度可以上线生产了，你信吗？</p>
<p>此时此刻，无数知识星球、自媒体、AI
导师教父们正在到处收割韭菜的学费。大意基本上都是教你如何
prompt（tool/skill 换汤不换药），然后让你多开 agent 并行干活。</p>
<h2 id="一个真实案例">一个真实案例</h2>
<p>Agent 的盲目自信不仅会误导使用者，也会误导 agent 自己。</p>
<p>我曾给 agent 这个任务：为当前 Kotlin 项目集成 GCP Transcoding
服务。我给了 agent 该产品的页面和文档作为参考，让它开始 plan。Agent
做出了如下计划：</p>
<ol type="1">
<li>通读文档后，发现该服务仅提供了 Java SDK，而当前项目使用的是 JVM
上的其他语言，并非原生支持</li>
<li>根据 RESTful 文档指示，结合文档定义字段，使用 ktor-client
进行手动接入</li>
<li>编写代码并执行测试</li>
</ol>
<p>你发现这份计划中存在的问题了吗？</p>
<p>事实上，如果你曾经「古法手工编程」做过此类工作，你会发现手动实现
RESTful 远没有想象中那么简单。哪怕仅实现 Transcoding
服务的基础能力，也涉及到 5-10 个 endpoint 调用。每个 endpoint
的输入输出参数又有几十甚至上百个字段嵌套定义，agent
在应对这类长上下文任务时会频繁犯错。</p>
<p>而如果 agent 选择对 Java SDK（Google 也是从 protobuf
生成出来的）进行简单包装隔离，大概半天到一天就可以让这个功能稳定上线。</p>
<p>若是让 agent 按照 RESTful 文档手动实现，agent 可能会陷入 debug
泥潭——因为当 AI
幻觉导致写错了可选字段的字段名（大小写、驼峰、下划线），程序不会立即报错。你需要多久才能发现它实现错了？等上线生产后客户投诉吗？</p>
<p><strong>为什么我们无法信任 agent？</strong>
经过一年的实践，我认为问题的根源在于：我们缺乏有效的验证手段。</p>
<h1 id="原因验证手段的全面失效">原因：验证手段的全面失效</h1>
<h2 id="code-review-失效">Code Review 失效</h2>
<blockquote>
<p>常见观点：某种意义上来说 AI
并没有取代程序员，只不过是一个新的高级工具罢了。你作为生产代码的人，还是得弄明白要干啥，合入的代码就得弄明白。</p>
</blockquote>
<p>但我认为，这个在实际项目里很难做到。</p>
<p>像我们之前内部 review 的时候，大部分时候 review 的是 code
style，作者讲一下设计思路，我们也就是大概一听就过了。以前这套方法是有效的：</p>
<ul>
<li>代码风格差的 PR，设计思路也一团糟，性能也差，也没什么可扩展性</li>
<li>代码风格好的
PR，设计思路都挺清晰，性能考虑也周到，就算有性能瓶颈也容易改，最后扩展性也不错</li>
</ul>
<p><strong>但是这个相关性在 agent
编码时代不存在，甚至相反。</strong></p>
<p>Agent
一分钟就能生成出来注释齐全、风格优秀的——屎山代码。反正我肉眼看过去的时候，经常会被这第一层假象蒙蔽，放松警惕。主要是这个屎山有点难在
review
阶段发现，经常是上线后出了问题，回头细查的时候才发现是「巧克力味的屎」。</p>
<p>你信我，opus、codex-xhigh 这些你们舍不得用的模型，我开 thinking+max
模式站起来蹬，一样有这个问题。</p>
<h2 id="测试失效">测试失效</h2>
<p>更不用说测试了。现在的 test cases 也是 AI vibe 出来的，agent
又当裁判又当运动员，它说什么就是什么。蒙我坑我也不是一次两次了。写了几千行
getter/setter 的 test case，最后测试全绿告诉我可以上生产环境发布了。</p>
<p>就像前面 GCP Transcoding 的例子，agent
写错了可选字段的字段名，测试照样能过，因为测试也是它自己写的，错的一致就是「对」的。</p>
<h2 id="与传统行业的对比">与传统行业的对比</h2>
<p>说到这里，有人可能会问：其他行业被机械、智能赋能后，难道就没有这个问题吗？</p>
<p>让我用 CNC 机床打个比方：</p>
<p>CNC
机床精度比我高，但机床产出工件后，我们可以对工件进行客观的物理测量——用卡尺量一下，公差是不是在
±0.01mm 以内，一目了然。即便我没有手搓出这个精度的能力，但我依然有评价
CNC 机床和工件质量的能力。</p>
<p><strong>这就是传统制造业被机械赋能后的状态：机器精度高，质量统一且稳定，而人依然能评价机器的产出。</strong></p>
<p>那么软件开发行业被 Agent 变革后，理想状态应该是什么样的？Agent
交付的代码确实覆盖了需求，具备基本的安全防护，且更容易长期维护（哪怕仅考虑
agent 自己维护，不考虑对人类的可读性），性能更高，资源占用更少。</p>
<p>但程序不仅需要完成眼下需求文档中的功能，还需要考虑到基本的安全防护。一个功能完成但安全漏洞百出的项目代码，同样是不合格的。</p>
<p>而目前我们还无法评价 agent
是否达到了这个状态。单就「功能实现」这一基础要求，agent
还不能脱离人的引导和测试验证——更别提安全性、可维护性、性能这些更高阶的指标了。</p>
<p>而且程序不是物理工件，不能用物理手段去测量。你没法拿卡尺量一下这段代码的「质量公差」是多少。</p>
<p>所以没法用衡量物理工件的标准去衡量程序，反而应该像衡量 CNC
机床本身一样——而一次生产（all tests
passed）远不能衡量机床质量，更不能衡量程序质量。</p>
<p>CNC
机床加工塑料、铝合金小件精度高，不代表加工钛合金、不锈钢精度也能达标。后者更考验整体刚性，以及工件质量大了以后热胀冷缩对程序进刀补偿的要求。</p>
<p>同理，vibe coding
出来的代码，本地点两下鼠标测试通过了，上线也是极大概率会直接炸掉。</p>
<p><strong>传统行业：机器精度高、质量稳定，人能评价。软件行业：Agent
产出快、覆盖广，但人还没法可靠地评价。这就是问题所在。</strong></p>
<h1 id="方案让编译器替你把关">方案：让编译器替你把关</h1>
<p>既然人工评价（Code
Review）和自动测试都靠不住，我们需要另一种评价手段——一种不依赖 agent
自己判断的、客观可验证的评价手段。</p>
<p>我的观点和主流 AI 编码观点相反：</p>
<p><strong>Agent
编程时代，更需要强类型，更需要严格可验证的语言，而不是放任 agent 去写
python/js/go，还有 anyscript。</strong></p>
<p>为什么？</p>
<p>AI 堆屎山这么快，别说生成个几万行了，就是生成超过 100
行我都已经懒得逐行去细读了。但是读类型签名、pre/post-condition
明显要快于通读逻辑代码。而这些东西只有 Rust/Scala/Haskell 甚至 formal
method 能提供。</p>
<p>我在 agent
编码前就一直用这种风格写自己的代码，主要是代码量大了以后，编译器检查比我肉眼检查更靠谱。现在
agent 编码流行起来了，我发现让 agent
遵循我的这个要求，更能控制产出代码质量——当然也只能说一定程度上，起码比什么都不做好。</p>
<p>回到 GCP Transcoding 的例子：如果 agent
用的是强类型语言，字段名写错了至少还能在编译期被类型系统拦住一部分。但
RESTful +
弱类型的组合，错了就是悄无声息地错，等你发现的时候已经晚了。</p>
<h2 id="实践效果">实践效果</h2>
<p>y1s1，该夸的还是要夸。现在的最新最强模型，过编译问题不大了，除非你比我还执着于类型体操。</p>
<p>放手让 agent 做工程还是拉垮的一批，但过编译已经问题不大了。Pure-FP
Scala、tagless final，opus 4.5 和 codex-xhigh
遵循得挺不错了，过编译也是自动的。函数式类型体操的编译错误基本上都是几十上百行的类型天书，agent
读懂并修复这些编译错误，在我写这篇文章时已经不再是困难。</p>
<h2 id="局限性">局限性</h2>
<p>当然，这个方案也有局限。</p>
<p>实际上现在的 formal method
工具链和生态还是很贫瘠，基本上只支持一门语言很有限很小的一个子集。有些工程上常用的语法/模式在
FM 那边都是
unsound，或者尚未证明。更不用说动不动就陷入死循环/无解证明了——稍不注意，z3
求解器要在比宇宙空间还大的可能性里搜索，到宇宙毁灭那一天都证明不出来。</p>
<p>强类型能解决一部分问题，但不是全部。</p>
<h1 id="更深的困境plan-与-execute">更深的困境：Plan 与 Execute</h1>
<p>即使有了强类型作为评价手段，还有一个更深层的问题：agent
对计划的理解和执行。</p>
<p>GCP Transcoding 的例子其实已经暴露了这个问题：agent 选择手动实现
RESTful 而不是包装 Java
SDK，这不是代码写错了，而是<strong>路线选错了</strong>。编译器能告诉你代码有没有语法错误，但没法告诉你该不该走这条路。</p>
<p>再举个更极端的例子：给 agent 一个复杂任务，研制一款火箭发动机。Plan
决定了做全流量分级燃烧循环，路线选择了共轴方案。</p>
<p><strong>Agent 不遵循的话：</strong>
可能就偏离到抽气循环也说不定。编译器能告诉你代码有没有语法错误，但没法告诉你这是不是你要的火箭发动机。</p>
<p><strong>Agent 遵循太好：</strong>
真的做出来共轴方案，那可能上线后会碰到更大的问题——共轴以后动密封系统做不好，氧化剂和燃料随着涡轮轴互相泄漏，俩预燃室要炸一个。编译器能保证类型正确，但没法保证设计合理。</p>
<p>现在的 plan/edit mode
切换也只是现阶段的权宜之计、无奈之举。这个问题比「评价手段缺失」更难解决，因为它涉及到对需求和设计的理解，而不仅仅是代码质量。</p>
<h1 id="初见即巅峰">初见即巅峰</h1>
<p>Agent 编程有一个显著的特点：<strong>初见即巅峰</strong>。</p>
<p>让 agent 开始一个全新的 CRUD 项目，或者一个 React 管理系统页面，agent
第一次的表现着实让所有人都大吃一惊——干净利落，结构清晰，甚至还贴心地加上了注释和错误处理。</p>
<p>但随着项目维护越来越久，那些「不可明说的」、没有被文档记录的、约定俗成的隐藏上下文越来越长。哪个字段其实已经废弃了但没删、哪个
API 有个历史遗留的
quirk、哪个模块之间有个微妙的依赖关系——这些东西，老员工心里都有数，但从来没人写下来。</p>
<p>而 agent
无法处理无限长的上下文，只能通过压缩、总结来选择性遗忘细节。可能被丢弃的是几次失败尝试的经验，也可能被丢弃的是关键数据结构的偏移量、寄存器地址、枚举定义。</p>
<p>每次新开一个 session
的时候，开发者不得不面对一个几乎全新的「员工」——它似乎继承了压缩后的上下文（claude.md
/
agents.md），但细节完全不知。你得重新跟它解释一遍：「不是，这个接口虽然文档上写的是这样，但实际上我们从来不传这个参数……」</p>
<p>对于 CRUD、Spring、React
这类重复度高的任务，这似乎不是什么痛点——反正每次都差不多，忘了就忘了。</p>
<p>但对于嵌入式系统开发，任何被遗忘的细节都可能被 agent
天马行空的幻觉填充。寄存器地址错了？中断优先级配错了？DMA
通道冲突了？轻则系统崩溃，重则永久烧坏硬件。这不是「改个 bug
重新部署」能解决的问题。</p>
<h1 id="agent-时代cs-基础还要学吗">Agent 时代，CS 基础还要学吗？</h1>
<p>既然评价 agent
产出是核心问题，那开发者的基础知识就必然还是要学的。不然你拿什么去评价
agent
生成的代码、模块、架构设计质量到底如何？没有评价能力的开发者，和保健品店里待宰的老头老太没有区别。</p>
<p>那么该如何学习呢？</p>
<p>打开 LeetCode，题目还没读完呢，Copilot 已经把答案补全出来了。点一下
Submit &amp; Run，前 1%。就这？</p>
<p>我的意见是：既然有 AI
了，当然不能局限于过去的难度，得上强度，<strong>上到 AI
做不出来的程度</strong>。</p>
<p>放心，该学的不会落下。上了强度以后 AI
幻觉越来越多，该补的课全都得补上。期间 AI
还会给你帮不少倒忙——但这恰恰是学习的机会。</p>
<p>比如你要实现 Red-Black Tree、B-Tree、AVL
Tree，那就上点强度：给算法加上形式化验证，再把泛型支持也加上。放心，当下最强模型也写不出来。</p>
<p>其实幻觉反而会帮助你学习——因为幻觉里包含了常见的误解，你去验证和纠正幻觉的过程，本身就加深了学习效果。</p>
<h1 id="结语">结语</h1>
<p>AI
框架、模型、工具、方法论层出不穷，日新月异。但说到底，这些都是在给模型做加法、打补丁。</p>
<p>人类完成一个完整工作流的时候，不需要把自己拆解成多个「子
agent」去协作——因为人类是真的有记忆能力，且会学习的。做的时间越长，成长越多，越熟练。项目里那些隐藏的上下文、踩过的坑、约定俗成的规矩，都会沉淀成经验。</p>
<p>而 agent
则相反。当前上下文越长，智力下降越明显。即便细节仍然在上下文内，agent
也开始频繁地忽略这些细节，自顾自地幻觉出一些「看起来合理」的东西来。</p>
<p>核心问题始终没变：我们依然缺乏可靠的手段来评价 agent
的产出。强类型是目前我找到的最实用的部分解，但也只是部分解。</p>
<p>一天不学，错过很多。一年不学，好像也没错过什么。</p>
<p>框架工具更新迭代，爆款层出不穷，但其炒作因素远大于实际能力和价值。而
CS
基础知识才是久经时间考验的硬通货。与其追新框架新工具，不如把精力放在强化自己「评价
Agent 产出」的能力上——这才是 agent 时代真正稀缺的东西。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2023/04/15/Improving-the-Display-of-Data-Lists-Designing-a-Real-Time-Event-Subscription-Architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/15/Improving-the-Display-of-Data-Lists-Designing-a-Real-Time-Event-Subscription-Architecture/" class="post-title-link" itemprop="url">Improving the Display of Data Lists: Designing a Real-Time Event Subscription Architecture</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-15 00:31:35" itemprop="dateCreated datePublished" datetime="2023-04-15T00:31:35+08:00">2023-04-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Many data systems use polling refresh to display lists, which can
cause a delay in updating content status and cannot immediately provide
feedback to users on the page. Shortening the refresh time interval on
the client side can lead to an excessive load on the server, which
should be avoided.</p>
<p>To solve this problem, this article proposes an event subscription
mechanism. This mechanism provides real-time updates to the client,
eliminating the need for polling refresh and improving the user
experience.</p>
<h1 id="terminologies-and-context">Terminologies and Context</h1>
<p>This article introduces the following concepts:</p>
<ul>
<li><strong>Hub</strong>: An event aggregation center that receives
events from producers and sends them to subscribers.</li>
<li><strong>Buffer</strong>: An event buffer that caches events from
producers and waits for the Hub to dispatch them to subscribers.</li>
<li><strong>Filter</strong>: An event filter that only sends events
meeting specified conditions to subscribers.</li>
<li><strong>Broadcast</strong>: An event broadcaster that broadcasts the
producer's events to all subscribers.</li>
<li><strong>Observer</strong>: An event observer that allows subscribers
to receive events through observers.</li>
</ul>
<p>The document discusses some common concepts such as:</p>
<ul>
<li>Pub-Sub pattern: It is a messaging pattern where the sender
(publisher) does not send messages directly to specific recipients
(subscribers). Instead, published messages are divided into different
categories without needing to know which subscribers (if any) exist.
Similarly, subscribers can express interest in one or more categories
and receive all messages related to that category, without the publisher
needing to know which subscribers (if any) exist.</li>
<li>Filter:
<ul>
<li>Topic-based content filtering mode is based on topic filtering
events. Producers publish events to one or more topics, and subscribers
can subscribe to one or more topics. Only events that match the
subscribed topics will be sent to subscribers. However, when a terminal
client subscribes directly, this method has too broad a subscription
range and is not suitable for a common hierarchical structure.</li>
<li>Content-based content filtering mode is based on message content
filtering events. Producers publish events to one or more topics, and
subscribers can use filters to subscribe to one or more topics. Only
events that match the subscribed topics will be sent to subscribers.
This method is suitable for a common hierarchical structure.</li>
</ul></li>
</ul>
<h2 id="functional-requirements">Functional Requirements</h2>
<ul>
<li>Client users can subscribe to events through gRPC Stream, WebSocket,
or ServerSentEvent.</li>
<li>Whenever a record's status changes (e.g. when the record is updated
by an automation task) or when other collaborators operate on the same
record simultaneously, an event will be triggered and pushed to the
message center.</li>
<li>Events will be filtered using content filtering mode, ensuring that
only events that meet the specified conditions are sent to
subscribers.</li>
</ul>
<h1 id="architecture">Architecture</h1>
<pre><code class="highlight mermaid">flowchart TD
  Hub([Hub])
  Buffer0[\&quot;Buffer drop oldest&quot;/]
  Buffer1[\&quot;Buffer1 drop oldest&quot;/]
  Buffer2[\&quot;Buffer2 drop oldest&quot;/]
  Buffer3[\&quot;Buffer3 drop oldest&quot;/]
  Filter1[\&quot;File(Record = 111)&quot;/]
  Filter2[\&quot;Workflow(Project = 222)&quot;/]
  Filter3[\&quot;File(Project = 333)&quot;/]
  Broadcast((Broadcast))
  Client1(Client1)
  Client2(Client2)
  Client3(Client3)
  Hub --&gt; Buffer0
  subgraph Server
    Buffer0 --&gt; Broadcast
    Broadcast --&gt; Filter1 --&gt; Buffer1 --&gt; Observer1
    Broadcast --&gt; Filter2 --&gt; Buffer2 --&gt; Observer2
    Broadcast --&gt; Filter3 --&gt; Buffer3 --&gt; Observer3
  end
  subgraph Clients
    Observer1 -.-&gt; Client1
    Observer2 -.-&gt; Client2
    Observer3 -.-&gt; Client3
  end</code></pre>
<h2 id="high-level-overview">High-Level Overview</h2>
<pre><code class="highlight mermaid">flowchart TD
  Pipe#a[[...Pipe...]]
  Pipe#b[[...Pipe...]]
  subgraph Hub
  direction LR
  Event1((Event1))
	Event2((Event2))
  Event3((Event3))
  Event4((Event4))
  Event5((Event5))
  Event6((Event6))
  Event7((Event7))
  Event8((Event8))
  Event1 -.-&gt; Event2 -.-&gt; Event3 -.-&gt; Event4 -.-&gt; Event5 -.-&gt; Event6 -.-&gt; Event7 -.-&gt; Event8
  end
	Pipe#a -.-&gt; Event1
  Event8 -.-&gt; Pipe#b
  subgraph Client1
  direction LR
  C1Subscribe((Start))
  C1Cancel((End))
  Event2 -.-&gt; C1Listen2
  Event3 -.-&gt; C1Listen3
  Event4 -.-&gt; C1Listen4
  Event5 -.-&gt; C1Listen5
  C1Subscribe -.-&gt; C1Listen2 -.-&gt; C1Listen3 -.-&gt; C1Listen4 -.-&gt; C1Listen5 -.-&gt; C1Cancel
  end
  subgraph Client2
  direction LR
  C2Subscribe((Start))
  C2Cancel((End))
  Lag((&quot;❌&quot;))
  C2Subscribe -.-&gt; C2Listen1 -- &quot;Poor Network&quot; ---&gt; Lag --&quot;Packet loss&quot;---&gt; C2Listen5 -.-&gt; C2Listen6 -.-&gt; C2Listen7 -.-&gt; C2Listen8 -.-&gt; C2Cancel
  Event1 -.-&gt; C2Listen1
  Event5 -.-&gt; C2Listen5
  Event6 -.-&gt; C2Listen6
  Event7 -.-&gt; C2Listen7
  Event8 -.-&gt; C2Listen8
  end</code></pre>
<p>Clients should follow these steps:</p>
<ul>
<li>Upon entering the page, subscribe as necessary.</li>
<li>After listening to the change event, debounce and re-request the
list interface, and then render it.</li>
<li>When leaving the page, cancel the subscription.</li>
</ul>
<p>Servers should follow these steps:</p>
<ul>
<li>Subscribe to push events based on the client's filter.</li>
<li>When the client's backlog message becomes too heavy, delete the
oldest message from the buffer.</li>
<li>When the client cancels the subscription, the server should also
cancel the broadcast to the client.</li>
</ul>
<h2 id="application-component-level-design-lld"><strong>Application /
Component Level Design (LLD)</strong></h2>
<pre><code class="highlight mermaid">flowchart LR
  Server([Server])
  Client([Client: Web...])
  MQ[Kafka or other]
  Broadcast((Broadcast))
  subgraph ExternalHub
    direction LR
    Receiver --&gt; MQ --&gt; Sender
  end
  subgraph InMemoryHub
    direction LR
    Emit -.-&gt; OnEach
  end
  Server -.-&gt; Emit
  Sender --&gt; Broadcast
  OnEach -.-&gt; Broadcast
  Broadcast -.-&gt; gRPC
  Broadcast -.-&gt; gRPC
  Broadcast -.-&gt; gRPC
  Server --  &quot;if horizon scale is needed&quot; --&gt; Receiver
  gRPC --Stream--&gt; Client</code></pre>
<p>For a single-node server, a simple Hub can be implemented using an
in-memory queue.</p>
<p>For multi-node servers, an external Hub implementation such as Kafka,
MQ, or Knative eventing should be considered. The broadcasting logic is
no different from that of a single machine.</p>
<h2 id="failure-modes"><strong>Failure Modes</strong></h2>
<h3 id="fast-producer-slow-consumer">Fast Producer-Slow Consumer</h3>
<p>This is a common scenario that requires special attention. The
publish-subscribe mechanism for terminal clients cannot always expect
clients to consume messages in real time. However, message continuity
must be maximally guaranteed. Clients may access our products in an
uncontrollable network environment, such as over 4G or poor Wi-Fi. Thus,
the server message queue cannot become too backlogged. When a client's
consumption rate cannot keep up with the server's production speed, this
article recommends using a bounded <code>Buffer</code> with the
<code>OverflowStrategy.DropOldest</code> strategy. This ensures that
subscriptions between consumers are isolated, avoiding too many unpushed
messages on the server (which could lead to potential memory leak
risks).</p>
<h1 id="alternative-design">Alternative Design</h1>
<p><a
target="_blank" rel="noopener" href="https://tanzu.vmware.com/content/blog/a-channel-based-ring-buffer-in-go">VMware
has publish a very similar design in 2013, but use Go
RingChannel</a></p>
<h1 id="summary">Summary</h1>
<p>This document proposes an event subscription mechanism to address the
delay in updating content status caused by polling refresh. Clients can
subscribe to events through any long connection protocol, and events
will be filtered based on specified conditions. To avoid having too many
unpushed messages on the server, a bounded buffer with the
<code>OverflowStrategy.DropOldest</code> strategy is used.</p>
<p>Implementing this in Reactive Streams is straightforward, but you can
choose your preferred technology to do so.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2023/03/19/Implementing-Version-Management-of-File-Trees-in-PostgreSQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/19/Implementing-Version-Management-of-File-Trees-in-PostgreSQL/" class="post-title-link" itemprop="url">Implementing Version Management of File Trees in PostgreSQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-19 20:37:00" itemprop="dateCreated datePublished" datetime="2023-03-19T20:37:00+08:00">2023-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="overview">Overview</h1>
<p>In the <a
href="/2023/03/19/Implement-the-file–tree-in-PostgreSQL-using-ltree/">previous
post</a>, we discussed how to implement a file tree in PostgreSQL using
<code>ltree</code>. Now, let's talk about how to integrate version
control management for the file tree.</p>
<p>Version control is a process for managing changes made to a file tree
over time. This allows for the tracking of its history and the ability
to revert to previous versions, making it an essential tool for file
management.</p>
<p>With version control, users have access to the most up-to-date
version of a file, and changes are tracked and documented in a
systematic manner. This ensures that there is a clear record of what has
been done, making it much easier to manage files and their versions.</p>
<h1 id="terminologies-and-context">Terminologies and Context</h1>
<p>One <strong>flawed</strong> implementation involves storing all file
metadata for every commit, including files that have not changed but are
recorded as <code>NO_CHANGE</code>. However, this approach has a
significant problem.</p>
<p>The problem with the simple and naive implementation of storing all
file metadata for every commit is that it leads to significant write
amplification, as even files that have not changed are recorded as
<code>NO_CHANGE</code>. One way to address this is to avoid storing
<code>NO_CHANGE</code> transformations when creating new versions, which
can significantly reduce the write amplification.</p>
<p>This is good for querying, but bad for writing. When we need to fetch
a specific version, the PostgreSQL engine only needs to scan the index
with the condition <code>file.version = ?</code>. This is a very cheap
cost in modern database systems. However, when a new version needs to be
created, the engine must write <span class="math inline">\(N\)</span>
rows of records into the log table (where <span
class="math inline">\(N\)</span> is the number of current files). This
will cause a write peak in the database and is unacceptable.</p>
<p>In theory, all we need to do is write the changed file. If we can
find a way to fetch an arbitrary version of the file tree in <span
class="math inline">\(O(log(n))\)</span> time, we can reduce unnecessary
write amplification.</p>
<h2 id="non-functional-requirements">Non Functional Requirements</h2>
<h2 id="scalability">Scalability</h2>
<p>Consider the worst-case scenario: a file tree with more than 1,000
files that is committed to more than 10,000 times. The scariest
possibility is that every commit changes all files, causing a decrease
in write performance compared to the efficient implementation. Storing
more than 10 million rows in a single table can make it difficult to
separate them into partitioned tables.</p>
<p>Suppose <span class="math inline">\(N\)</span> is the number of
files, and <span class="math inline">\(M\)</span> is the number of
commits. We need to ensure that the time complexity of fetching a
snapshot of an arbitrary version is less than <span
class="math inline">\(O(N\cdot log(M))\)</span>. This is theoretically
possible.</p>
<h2 id="latency">Latency</h2>
<p>In the worst case, the query can still respond in less than
100ms.</p>
<h1 id="architecture">Architecture</h1>
<h2 id="database-design">Database Design</h2>
<p>Illustration of data structures.</p>
<figure>
<img
src="/images/Implementing-Version-Management-of-File-Trees-in-PostgreSQL/file-tree-version-rdbms.png"
alt="Illustration of data structures." />
<figcaption aria-hidden="true">Illustration of data
structures.</figcaption>
</figure>
<h2 id="tech-details">Tech Details</h2>
<blockquote>
<p>Subqueries appearing in <code>FROM</code> can be preceded by the key
word <code>LATERAL</code>. This allows them to reference columns
provided by preceding <code>FROM</code> items.
(Without <code>LATERAL</code>, each subquery is evaluated independently
and so cannot cross-reference any other <code>FROM</code> item.) — <a
target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/queries-table-expressions.html#QUERIES-LATERAL">https://www.postgresql.org/docs/current/queries-table-expressions.html#QUERIES-LATERAL</a></p>
</blockquote>
<p>PostgreSQL has a keyword called <code>LATERAL</code>. This keyword
can be used in a join table to enable the use of an outside table in a
<code>WHERE</code> condition. By doing so, we can directly tell the
query optimizer how to use the index. Since data in a combined index is
stored in an ordered tree, finding the maximum value or any arbitrarily
value has a time complexity of <span
class="math inline">\(O(log(n))\)</span>.</p>
<p>Finally, we obtain a time complexity of <span
class="math inline">\(O(N \cdot log(M))\)</span>.</p>
<h3 id="performance">Performance</h3>
<p>Result: Fetching an arbitrary version will be done in tens of
milliseconds.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">explain analyse</span><br><span class="line"><span class="keyword">select</span> f.record_id, f.filename, latest.revision_id</span><br><span class="line"><span class="keyword">from</span> files f</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> <span class="keyword">lateral</span> (</span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">        <span class="keyword">from</span> file_logs fl</span><br><span class="line">        <span class="keyword">where</span> f.filename <span class="operator">=</span> fl.filename</span><br><span class="line">          <span class="keyword">and</span> f.record_id <span class="operator">=</span> fl.record_id</span><br><span class="line">          <span class="comment">-- and revision_id &lt; 20000</span></span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> revision_id <span class="keyword">desc</span></span><br><span class="line">        limit <span class="number">1</span></span><br><span class="line">    ) <span class="keyword">as</span> latest</span><br><span class="line"><span class="keyword">on</span> f.record_id <span class="operator">=</span> <span class="string">&#x27;f5c2049f-5a32-44f5-b0cc-b7e0531bf706&#x27;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Nested Loop  (cost<span class="operator">=</span><span class="number">0.86</span>.<span class="number">.979</span><span class="number">.71</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1445</span> width<span class="operator">=</span><span class="number">50</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.040</span>.<span class="number">.18</span><span class="number">.297</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1445</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Index <span class="keyword">Only</span> Scan <span class="keyword">using</span> files_pkey <span class="keyword">on</span> files f  (cost<span class="operator">=</span><span class="number">0.29</span>.<span class="number">.89</span><span class="number">.58</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1445</span> width<span class="operator">=</span><span class="number">46</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.019</span>.<span class="number">.0</span><span class="number">.174</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1445</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">        Index Cond: (record_id <span class="operator">=</span> <span class="string">&#x27;f5c2049f-5a32-44f5-b0cc-b7e0531bf706&#x27;</span>::uuid)</span><br><span class="line">        Heap Fetches: <span class="number">0</span></span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Memoize  (cost<span class="operator">=</span><span class="number">0.57</span>.<span class="number">.0</span><span class="number">.65</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">4</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.012</span>.<span class="number">.0</span><span class="number">.012</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> loops<span class="operator">=</span><span class="number">1445</span>)</span><br><span class="line">&quot;        Cache Key: f.filename, f.record_id&quot;</span><br><span class="line">        Cache Mode: <span class="type">binary</span></span><br><span class="line">        Hits: <span class="number">0</span>  Misses: <span class="number">1445</span>  Evictions: <span class="number">0</span>  Overflows: <span class="number">0</span>  Memory Usage: <span class="number">221</span>kB</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Subquery Scan <span class="keyword">on</span> latest  (cost<span class="operator">=</span><span class="number">0.56</span>.<span class="number">.0</span><span class="number">.64</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">4</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.012</span>.<span class="number">.0</span><span class="number">.012</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> loops<span class="operator">=</span><span class="number">1445</span>)</span><br><span class="line">              <span class="operator">-</span><span class="operator">&gt;</span>  Limit  (cost<span class="operator">=</span><span class="number">0.56</span>.<span class="number">.0</span><span class="number">.63</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">852</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.012</span>.<span class="number">.0</span><span class="number">.012</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> loops<span class="operator">=</span><span class="number">1445</span>)</span><br><span class="line">                    <span class="operator">-</span><span class="operator">&gt;</span>  Index <span class="keyword">Only</span> Scan Backward <span class="keyword">using</span> file_logs_pk <span class="keyword">on</span> file_logs fl  (cost<span class="operator">=</span><span class="number">0.56</span>.<span class="number">.11</span><span class="number">.72</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">158</span> width<span class="operator">=</span><span class="number">852</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.011</span>.<span class="number">.0</span><span class="number">.011</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> loops<span class="operator">=</span><span class="number">1445</span>)</span><br><span class="line">                          Index Cond: ((record_id <span class="operator">=</span> f.record_id) <span class="keyword">AND</span> (filename <span class="operator">=</span> (f.filename)::text))</span><br><span class="line">                          Heap Fetches: <span class="number">0</span></span><br><span class="line">Planning <span class="type">Time</span>: <span class="number">0.117</span> ms</span><br><span class="line">Execution <span class="type">Time</span>: <span class="number">18.384</span> ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="test-datasets">Test Datasets</h3>
<p>This dataset simulates the worst-case scenario of a table with 14.6
million rows. Specifically, it contains 14.45 million rows representing
a situation in which 1,400 files are changed 10,000 times.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- cnt: 14605858</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">0</span>) <span class="keyword">from</span> file_logs;</span><br><span class="line"><span class="comment">-- cnt: 14451538</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">0</span>) <span class="keyword">from</span> file_logs <span class="keyword">where</span> record_id <span class="operator">=</span> <span class="string">&#x27;f5c2049f-5a32-44f5-b0cc-b7e0531bf706&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="schema">Schema</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create table</span> public.file_logs</span><br><span class="line">(</span><br><span class="line">    file_key    ltree         <span class="keyword">not null</span>,</span><br><span class="line">    revision_id <span class="type">integer</span>       <span class="keyword">not null</span>,</span><br><span class="line">    record_id   uuid          <span class="keyword">not null</span>,</span><br><span class="line">    filename    <span class="type">varchar</span>(<span class="number">2048</span>) <span class="keyword">not null</span>,</span><br><span class="line">    create_time <span class="type">timestamp</span>,</span><br><span class="line">    update_time <span class="type">timestamp</span>,</span><br><span class="line">    delete_time <span class="type">timestamp</span>,</span><br><span class="line">    blob_sha256 <span class="type">char</span>(<span class="number">64</span>),</span><br><span class="line">    <span class="keyword">constraint</span> file_logs_pk</span><br><span class="line">        <span class="keyword">primary key</span> (record_id, filename, revision_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter table</span> public.file_logs</span><br><span class="line">    owner <span class="keyword">to</span> postgres;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create table</span> public.files</span><br><span class="line">(</span><br><span class="line">    record_id uuid          <span class="keyword">not null</span>,</span><br><span class="line">    filename  <span class="type">varchar</span>(<span class="number">2048</span>) <span class="keyword">not null</span>,</span><br><span class="line">    create_at <span class="type">timestamp</span>     <span class="keyword">not null</span>,</span><br><span class="line">    <span class="keyword">primary key</span> (record_id, filename)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter table</span> public.files</span><br><span class="line">    owner <span class="keyword">to</span> postgres;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="further-improvements"><strong>Further Improvements</strong></h1>
<p>We can implement this using an intuitive approach in a graph
database.</p>
<figure>
<img
src="/images/Implementing-Version-Management-of-File-Trees-in-PostgreSQL/file-tree-version-graph-database.png"
alt="File tree version in graph database" />
<figcaption aria-hidden="true">File tree version in graph
database</figcaption>
</figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2023/03/19/Implement-the-file%E2%80%93tree-in-PostgreSQL-using-ltree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/19/Implement-the-file%E2%80%93tree-in-PostgreSQL-using-ltree/" class="post-title-link" itemprop="url">Implement the file tree in PostgreSQL using ltree</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-19 18:18:18" itemprop="dateCreated datePublished" datetime="2023-03-19T18:18:18+08:00">2023-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="background">Background</h1>
<p>A file tree is a hierarchical structure used to organize files and
directories on a computer. It allows users to easily navigate and access
their files and folders, and is commonly used in operating systems and
file management software.</p>
<p>But implementing file trees in traditional RDBMS like MySQL can be a
challenge due to the lack of support for hierarchical data structures.
However, there are workarounds such as using nested sets or materialized
path approaches. Alternatively, you could consider using NoSQL databases
like MongoDB or document-oriented databases like Couchbase, which have
built-in support for hierarchical data structures.</p>
<p>It is possible to implement a file tree in PostgreSQL using the
<code>ltree</code> datatype provided by PostgreSQL. This datatype can
help us build the hierarchy within the database.</p>
<h1 id="tldr">TL;DR</h1>
<h2 id="pros">Pros</h2>
<ul>
<li>Excellent performance!</li>
<li>No migration is needed for this, as no new columns will be added.
Only a new expression index needs to be created.</li>
</ul>
<h2 id="cons">Cons</h2>
<ul>
<li>Need additional mechanism to create virtual folder entities.(only if
you need to show the folder level)</li>
<li>There are limitations on the file/folder name length.(especially in
non-ASCII characters)</li>
</ul>
<h2 id="limitation">Limitation</h2>
<p>The maximum length for a file or directory name is limited, and in
the worst case scenario where non-ASCII characters(Chinese) and
alphabets are interlaced, it can not be longer than <strong>33</strong>
characters. Even if all the characters are Chinese, the name can not
exceed <strong>62</strong> characters in length.</p>
<p>Based on PostgreSQL <a
target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/ltree.html#id-1.11.7.32.5">documentation</a>,
the label path can not exceed 65535 labels. However, in most cases, this
limit should be sufficient and it is unlikely that you would need to
nest directories to such a deep level.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> escape_filename_for_ltree(</span><br><span class="line">    <span class="string">&#x27;一0二0三0四0五0六0七0八0九0十0&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一0二0三0四0五0六0七0八0九0十0&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一0二0三0四0五0六0七0八0九0十0&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一0二0&#x27;</span></span><br><span class="line">); <span class="comment">-- worst case len 34</span></span><br><span class="line"><span class="keyword">select</span> escape_filename_for_ltree(</span><br><span class="line">    <span class="string">&#x27;一二三四五六七八九十&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一二三四五六七八九十&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一二三四五六七八九十&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一二三四五六七八九十&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一二三四五六七八九十&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一二三四五六七八九十&#x27;</span> <span class="operator">||</span></span><br><span class="line">    <span class="string">&#x27;一二三&#x27;</span></span><br><span class="line">); <span class="comment">-- Chinese case len 63</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[42622] ERROR: label string is too long Detail: Label length is 259, must be at most 255, at character 260. Where: PL/pgSQL function escape_filename_for_ltree(text) line 5 at SQL statement</span><br></pre></td></tr></table></figure>
<h1 id="how-to-use">How to use</h1>
<p>Build expression index</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_file_tree_filename <span class="keyword">ON</span> files <span class="keyword">using</span> gist (escape_filename_for_ltree(filename));</span><br></pre></td></tr></table></figure>
<p>Example Query</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">explain analyse</span><br><span class="line"><span class="keyword">select</span> filename</span><br><span class="line"><span class="keyword">from</span> files</span><br><span class="line"><span class="keyword">where</span> escape_filename_for_ltree(filename) <span class="operator">~</span> <span class="string">&#x27;ow.*&#123;1&#125;&#x27;</span></span><br><span class="line">  <span class="keyword">and</span> record_id <span class="operator">=</span> <span class="string">&#x27;1666bad1-202c-496e-bb0e-9664ce3febcb&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>Query Result</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ow/ros_00000000_2022-03-02-12-55-19_330.bag</span><br><span class="line">ow/ros_00011426_2022-08-15-19-24-11_0.bag</span><br><span class="line">ow/ros_00019378_2022-08-12-18-40-06_0.bag</span><br><span class="line">ow/ros_00011426_2022-08-15-19-24-11_0.bag</span><br><span class="line">ow/ros_00011426_2022-08-15-19-24-11_0.bag.coscene-reserved-index</span><br></pre></td></tr></table></figure>
<p>Query Explain</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Bitmap Heap Scan <span class="keyword">on</span> files  (cost<span class="operator">=</span><span class="number">32.12</span>.<span class="number">.36</span><span class="number">.38</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">28</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.341</span>.<span class="number">.0</span><span class="number">.355</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">8</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">  Recheck Cond: ((record_id <span class="operator">=</span> <span class="string">&#x27;1666bad1-202c-496e-bb0e-9664ce3febcb&#x27;</span>::uuid) <span class="keyword">AND</span> (escape_filename_for_ltree((filename)::text) <span class="operator">&lt;</span>@ <span class="string">&#x27;ow&#x27;</span>::ltree))</span><br><span class="line">  Heap Blocks: exact<span class="operator">=</span><span class="number">3</span></span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  BitmapAnd  (cost<span class="operator">=</span><span class="number">32.12</span>.<span class="number">.32</span><span class="number">.12</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">0</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.323</span>.<span class="number">.0</span><span class="number">.324</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">0</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> idx_file_tree_record_id  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.4</span><span class="number">.99</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">93</span> width<span class="operator">=</span><span class="number">0</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.051</span>.<span class="number">.0</span><span class="number">.051</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">100</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">              Index Cond: (record_id <span class="operator">=</span> <span class="string">&#x27;1666bad1-202c-496e-bb0e-9664ce3febcb&#x27;</span>::uuid)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> idx_file_tree_filename  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.26</span><span class="number">.88</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">347</span> width<span class="operator">=</span><span class="number">0</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.253</span>.<span class="number">.0</span><span class="number">.253</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">52</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">              Index Cond: (escape_filename_for_ltree((filename)::text) <span class="operator">&lt;</span>@ <span class="string">&#x27;ow&#x27;</span>::ltree)</span><br><span class="line">Planning <span class="type">Time</span>: <span class="number">0.910</span> ms</span><br><span class="line">Execution <span class="type">Time</span>: <span class="number">0.599</span> ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="explaination">Explaination</h1>
<p>PostgreSQL's LTREE data type allows you to use a sequence of
alphanumeric characters and <strong>underscores</strong> on the label,
with a maximum length of 256 characters. So, we get a special character
<strong>underscore</strong> that can be used as a notation to
<strong>build our escape rules</strong> within the label.</p>
<p><strong>Slashes(<code>/</code>)</strong> will be
<strong>replaced</strong> with <strong>dots(<code>.</code>)</strong>. I
think it does not require further explanation.</p>
<p>Initially, I attempted to encode all non-alphabetic characters into
their Unicode hex format. However, after receiving advice from other
guys, I discovered that using <strong>base64</strong> encoding can be
more efficient in terms of information entropy. Ultimately, I decided to
use <strong>base62</strong> encoding instead to ensure that no illegal
characters are produced and to achieve the maximum possible information
entropy.</p>
<p>This is the final representation of the physical data that will be
stored in the index of PostgreSQL.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> escape_filename_for_ltree(<span class="string">&#x27;root/folder1/机器人仿真gazebo11-noetic集成ROS1/state.log&#x27;</span>);</span><br><span class="line"><span class="comment">-- result:</span></span><br><span class="line"><span class="comment">-- root.folder1._1hOBTVt5n7EhFWzIbUcjT_gazebo11_j_noetic_1Aw3qhY48_ROS1.state_k_log</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="further">Further</h1>
<p>If you want to store an isolated file tree in the same table, one
thing you need to do is prepend the isolation key as the first label of
the ltree. For example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> escape_filename_for_ltree(<span class="string">&#x27;&lt;put_user_id_in_there&gt;&#x27;</span> <span class="operator">||</span> <span class="string">&#x27;/&#x27;</span> <span class="operator">||</span> <span class="string">&#x27;&lt;path_to_file&gt;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>By doing this, you will get the best query performance.</p>
<h1 id="summary">Summary</h1>
<p>This document explains how to implement a file tree in PostgreSQL
using the <code>ltree</code> datatype. The <code>ltree</code> datatype
can help build the hierarchy within the database, and an expression
index needs to be created. There are some limitations on the file/folder
name length, but the performance is excellent. The document also
provides PostgreSQL functions for escaping and encoding file/folder
names.</p>
<h1 id="appendix-postgresql-functions">Appendix: PostgreSQL
Functions</h1>
<h2 id="entry-function-immutable-is-required">Entry function (immutable
is required)</h2>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> escape_filename_for_ltree(filename TEXT)</span><br><span class="line">    <span class="keyword">RETURNS</span> ltree <span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    escaped_path ltree;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">select</span> string_agg(escape_part(part), <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="keyword">into</span> escaped_path</span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> regexp_split_to_table <span class="keyword">as</span> part</span><br><span class="line">          <span class="keyword">from</span> regexp_split_to_table(filename, <span class="string">&#x27;/&#x27;</span>)) <span class="keyword">as</span> parts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> escaped_path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql IMMUTABLE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="util-escape-every-part-folder-or-file">Util: Escape every part
(folder or file)</h2>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">function</span> escape_part(part text) <span class="keyword">returns</span> text <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">    escaped_part text;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">select</span> string_agg(escaped, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">into</span> escaped_part</span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">case</span> <span class="built_in">substring</span>(sep, <span class="number">1</span>, <span class="number">1</span>) <span class="operator">~</span> <span class="string">&#x27;[0-9a-zA-Z]&#x27;</span></span><br><span class="line">                     <span class="keyword">when</span> <span class="literal">true</span> <span class="keyword">then</span> sep</span><br><span class="line">                     <span class="keyword">else</span> <span class="string">&#x27;_&#x27;</span> <span class="operator">||</span> base62_encode(sep) <span class="operator">||</span> <span class="string">&#x27;_&#x27;</span></span><br><span class="line">                     <span class="keyword">end</span> <span class="keyword">as</span> escaped</span><br><span class="line">          <span class="keyword">from</span> (<span class="keyword">select</span> split_string_by_alpha <span class="keyword">as</span> sep</span><br><span class="line">                <span class="keyword">from</span> split_string_by_alpha(part)) <span class="keyword">as</span> split) <span class="keyword">as</span> <span class="keyword">escape</span>;</span><br><span class="line">    <span class="keyword">RETURN</span> escaped_part;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">$$ <span class="keyword">language</span> plpgsql immutable</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="util-split-a-string-into-groups">Util: Split a string into
groups</h2>
<p>Each group contains only alphabetic characters or non-alphabetic
characters.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> split_string_by_alpha(input_str TEXT) <span class="keyword">RETURNS</span> SETOF TEXT <span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    split_str TEXT;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF input_str <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> input_str <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">RETURN</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">    WHILE input_str <span class="operator">!=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        LOOP</span><br><span class="line">            split_str :<span class="operator">=</span> <span class="built_in">substring</span>(input_str <span class="keyword">from</span> <span class="string">&#x27;[^0-9a-zA-Z]+|[0-9a-zA-Z]+&#x27;</span>);</span><br><span class="line">            IF split_str <span class="operator">!=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">RETURN</span> NEXT split_str;</span><br><span class="line">            <span class="keyword">END</span> IF;</span><br><span class="line">            input_str :<span class="operator">=</span> <span class="built_in">substring</span>(input_str <span class="keyword">from</span> length(split_str) <span class="operator">+</span> <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">END</span> LOOP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="util-base62-encode-function">Util: base62 encode function</h2>
<p>By using the base62_encode function, we can create a string that
meets the requirements of LTREE and achieves maximum information
entropy.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> base62_encode(data TEXT) <span class="keyword">RETURNS</span> TEXT <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    ALPHABET <span class="type">CHAR</span>(<span class="number">62</span>)[] :<span class="operator">=</span> <span class="keyword">ARRAY</span>[</span><br><span class="line">        <span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;O&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>,<span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;U&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;Z&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;j&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;q&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;z&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    BASE <span class="type">BIGINT</span> :<span class="operator">=</span> <span class="number">62</span>;</span><br><span class="line">    <span class="keyword">result</span> TEXT :<span class="operator">=</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    val <span class="type">numeric</span> :<span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    bytes bytea :<span class="operator">=</span> data::bytea;</span><br><span class="line">    len <span class="type">INT</span> :<span class="operator">=</span> length(data::bytea);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">FOR</span> i <span class="keyword">IN</span> <span class="number">0.</span>.(len <span class="operator">-</span> <span class="number">1</span>) LOOP</span><br><span class="line">        val :<span class="operator">=</span> (val <span class="operator">*</span> <span class="number">256</span>) <span class="operator">+</span> get_byte(bytes, i);</span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line"></span><br><span class="line">    WHILE val <span class="operator">&gt;</span> <span class="number">0</span> LOOP</span><br><span class="line">        <span class="keyword">result</span> :<span class="operator">=</span> ALPHABET[val <span class="operator">%</span> BASE <span class="operator">+</span> <span class="number">1</span>] <span class="operator">||</span> <span class="keyword">result</span>;</span><br><span class="line">        val :<span class="operator">=</span> <span class="built_in">floor</span>(val <span class="operator">/</span> BASE);</span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">result</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2022/08/21/talking-about-resource-security/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/21/talking-about-resource-security/" class="post-title-link" itemprop="url">浅谈资源安全</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-21 12:12:43" itemprop="dateCreated datePublished" datetime="2022-08-21T12:12:43+08:00">2022-08-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="起因">起因</h1>
<p>这个月（2022年8月）于Rust二群与某人辩论，因为某人坚持认为 Rust
的所有权 <code>Ownership</code> 机制仅仅是等同于垃圾回收
<code>Garbage Collection</code> ，而我认为 <code>Ownership</code>
还解决了另一个困扰无数码农的问题：<strong>资源安全</strong></p>
<h1 id="定义">定义</h1>
<p>常见资源可以分为三大类：</p>
<ul>
<li>文件
<ul>
<li>Socket
<ul>
<li>TCP</li>
<li>HTTP</li>
<li>JDBC</li>
</ul></li>
<li>文件系统</li>
</ul></li>
<li>锁
<ul>
<li>本地</li>
<li>远程（Redis，RDBMS）</li>
</ul></li>
<li>逻辑资源
<ul>
<li>Stream（背后可能是文件）</li>
<li>日志区块或长链接起止符</li>
<li>临时文件删除</li>
</ul></li>
</ul>
<p>而资源管理总共分三步，分别是：</p>
<ol type="1">
<li>资源申请</li>
<li>资源使用</li>
<li>资源释放</li>
</ol>
<p>这三个事件需要严格按顺序发生。</p>
<p>而资源安全关注的是:</p>
<ul>
<li>在使用前已经正确初始化</li>
<li>使用后能被正确释放</li>
<li>释放后不能被再次使用</li>
</ul>
<p>语言（语法）提供的资源管理有什么用呢？它给程序员一个强有力的保证，非极端情况下（断电等），资源释放逻辑必定会被执行。</p>
<h1 id="资源管理的历史">资源管理的历史</h1>
<h2 id="史前">史前</h2>
<h3 id="c">C</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">int</span> num;</span><br><span class="line">   FILE *fptr;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ((fptr = fopen(<span class="string">&quot;C:\\program.txt&quot;</span>,<span class="string">&quot;r&quot;</span>)) == <span class="literal">NULL</span>)&#123;</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;Error! opening file&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Program exits if the file pointer returns NULL.</span></span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">fscanf</span>(fptr,<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Value of n=%d&quot;</span>, num);</span><br><span class="line">   fclose(fptr); </span><br><span class="line">  </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>早期的计算机语言并没有意识到资源管理问题，依然是指令式编码风格，需要程序员自己保证资源的申请与释放。同时那个年代软件系统并不复杂，再加上从业者素质普遍较高，所以资源管理问题不像今天这么突出。</p>
<h2 id="语言结构language-constructs">语言结构(Language constructs)</h2>
<p>后来，有些语言引入了异常机制，允许程序无视控制流语句自行中断并跳出，资源管理也变得复杂起来。支持抛出异常的语言通常使用
<code>try &#123;&#125; catch &#123;&#125; finally &#123;&#125;</code> 约束资源作用范围，
<code>try</code> 关键字表示资源作用范围，无论程序以任何形式跳出，
<code>finally</code>
关键字标记代码块都应当被确保执行，资源正确释放，代表语法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(path);</span><br><span class="line"><span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(fr);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> br.readLine();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    br.close();</span><br><span class="line">    fr.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="销毁模式dispose-pattern">销毁模式(Dispose pattern)</h2>
<p>这个模式也是当今大部分有 GC 语言所支持的，比如 Java 语法关键字
<code>try</code></p>
<p>据我所知 Java 所谓的资源安全只有 Java7 时代引入的
try-with-resource，资源需继承自<code>AutoCloseable</code>，可以在
<code>try(...) &#123; ... code block ... &#125;</code>
内放心使用，也就意味着异步代码没有任何保障。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> String <span class="title function_">readFirstLineFromFile</span><span class="params">(String path)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(path);</span><br><span class="line">         <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(fr)) &#123;</span><br><span class="line">        <span class="keyword">return</span> br.readLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="resource-monad-模式">Resource Monad 模式</h2>
<p>后续发展中诞生的较为安全的设计模式，将使用资源的同步或异步代码包裹在一个代码块中，使用结束后释放，这样可以避免在每次使用资源后手动关闭。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;R&gt; CompletionStage&lt;R&gt; <span class="title function_">use</span> <span class="params">(Function&lt;Resource, CompletionStage&lt;R&gt;&gt; f)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> Resource.make()</span><br><span class="line">    .thenCompose((res) -&gt; f.apply(res)</span><br><span class="line">      .handle((r, e) -&gt; &#123;</span><br><span class="line">        res.close();</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">use((res) -&gt; &#123;</span><br><span class="line">  System.out.println(res);</span><br><span class="line">  <span class="comment">// 将业务逻辑编写到 CompletableFuture 内部执行</span></span><br><span class="line">  <span class="keyword">return</span> CompletableFuture.failedStage(<span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;error&quot;</span>));</span><br><span class="line">&#125;).handle((r, e) -&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">    System.out.println(e.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>以上方案都有一个缺陷，在使用过程中误将资源变量共享给其他代码段（闭包，回调，外部变量，无意中发送给队列
HTTP Response，例如如下 Java 代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> HttpEntity <span class="title function_">fileEntity</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">try</span> (<span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(path);</span><br><span class="line">       <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(fr)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpEntity</span>(br);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 <code>HttpEntity</code> 类并不是在创建时消费 <code>Reader</code>
，而是会等待 HTTP Body
传输时才开始读取字节流，那毫无疑问，这会造成访问已关闭资源，可能引起应用程序崩溃。</p>
<p>正确的写法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 伪代码</span></span><br><span class="line"><span class="keyword">static</span> HttpEntity <span class="title function_">fileEntity</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(path);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(fr);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpEntity</span>(br) &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">      br.close();</span><br><span class="line">      fr.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="raii">RAII</h2>
<h3 id="c-1">C++</h3>
<blockquote>
<p>Move semantics make it possible to safely transfer resource ownership
between objects, across scopes, and in and out of threads, while
maintaining resource safety. — (since C++11)</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void <span class="title function_ invoke__">f</span>()</span><br><span class="line">&#123;</span><br><span class="line">    vector&lt;string&gt; <span class="title function_ invoke__">vs</span>(<span class="number">100</span>);   <span class="comment">// not std::vector: valid() added</span></span><br><span class="line">    <span class="keyword">if</span> (!vs.<span class="title function_ invoke__">valid</span>()) &#123;</span><br><span class="line">        <span class="comment">// handle error or exit</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ifstream <span class="title function_ invoke__">fs</span>(<span class="string">&quot;foo&quot;</span>);   <span class="comment">// not std::ifstream: valid() added</span></span><br><span class="line">    <span class="keyword">if</span> (!fs.<span class="title function_ invoke__">valid</span>()) &#123;</span><br><span class="line">        <span class="comment">// handle error or exit</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="comment">// destructors clean up as usual</span></span><br></pre></td></tr></table></figure>
<p>C++ 提出了 RAII 这一先进概念，几乎解决了资源安全问题。但是受限于 C++
诞生年代，早期 C++ 为了保证资源安全，只支持左值引用(LValue Reference) +
Clone(Deep Copy)
语义，使得赋值操作会频繁深拷贝整个对象与频繁构造/析构资源，浪费了很多操作。C++11
开始支持右值引用，但是仍然需要实现右值引用(RValue Reference)的
Move(Shallow Copy)。同时，C++ 无法检查多次 move 的问题和 move
后原始变量仍然可用的问题。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">A</span>(<span class="type">const</span> string&amp; str, <span class="type">int</span>* arr):_str(str),_arr(arr)&#123;cout &lt;&lt; <span class="string">&quot;parameter ctor&quot;</span> &lt;&lt; endl;&#125;</span><br><span class="line">        <span class="built_in">A</span>(A&amp;&amp; obj):_str(std::<span class="built_in">move</span>(obj._str)),_arr(std::<span class="built_in">move</span>(obj._arr))&#123;obj._arr = <span class="literal">nullptr</span>;cout &lt;&lt; <span class="string">&quot;move ctor&quot;</span> &lt;&lt; endl;&#125;</span><br><span class="line">        A&amp; <span class="keyword">operator</span> =(A&amp;&amp; rhs)&#123;</span><br><span class="line">            _str = std::<span class="built_in">move</span>(rhs._str);</span><br><span class="line">            _arr = std::<span class="built_in">move</span>(rhs._arr);</span><br><span class="line">            rhs._arr = <span class="literal">nullptr</span>;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;move assignment operation&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;</span><br><span class="line">            cout &lt;&lt; _str &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">A</span>()&#123;</span><br><span class="line">            <span class="keyword">delete</span>[] _arr;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;dtor&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        string _str;</span><br><span class="line">        <span class="type">int</span>* _arr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span>* arr = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">6</span>] &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">4</span>&#125;;</span><br><span class="line">    <span class="function">A <span class="title">a</span><span class="params">(<span class="string">&quot;Yajuu Senpai&quot;</span>, std::move(arr))</span></span>; <span class="comment">// 错误的指针移动 --&gt; STUPID MOVE!!</span></span><br><span class="line">    <span class="function">A <span class="title">b</span><span class="params">(std::move(a))</span></span>;   <span class="comment">// move ctor</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;print a: &quot;</span>;</span><br><span class="line">    a.<span class="built_in">print</span>();           <span class="comment">// a 失去所有权  --&gt; CORRECT!!</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;print b: &quot;</span>;</span><br><span class="line">    b.<span class="built_in">print</span>();           <span class="comment">// b 获得所有权  --&gt; CORRECT!!</span></span><br><span class="line"></span><br><span class="line">    b = std::<span class="built_in">move</span>(a);    <span class="comment">// 二次移动</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;print a: &quot;</span>; </span><br><span class="line">    a.<span class="built_in">print</span>();           <span class="comment">// ???</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;print b: &quot;</span>; </span><br><span class="line">    b.<span class="built_in">print</span>();           <span class="comment">// ???</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="rust">Rust</h3>
<p>继承自 <strong>C++ RAII
，</strong>当创建资源和使用资源不在同一个领域时，Rust 的
<code>move</code> / <code>borrow</code>
依然可以安心睡觉，这种语言级别的保证让我一个写 Scala 的看了都羡慕。</p>
<p>在Rust 中<code>move</code> 给别人就是别人负责 <code>drop</code>，
<code>borrow</code> 给别人还是自己负责
<code>drop</code>，且编译器会根据生命周期检查，确保不会发生多次
<code>move</code>，也不会有超出拥有者(<code>owner</code>)的借用(<code>&amp;borrow</code>)发生。责任划分很清晰，只要自己脑子清醒，完全不担心异步的时候会泄漏。</p>
<p>程序员无法显式 <code>delete</code>，只能遵守 Rust
语法，编译器依据变量生命周期将相关变量的 <code>drop</code>
插入到正确位置，通常是离开块级作用域的位置。</p>
<figure>
<img src="/images/rust-drop.png" alt="Rust Drop" />
<figcaption aria-hidden="true">Rust Drop</figcaption>
</figure>
<p><a
target="_blank" rel="noopener" href="https://doc.rust-lang.org/rust-by-example/scope/raii.html">https://doc.rust-lang.org/rust-by-example/scope/raii.html</a></p>
<p>同步示例如下：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">  connection: &amp;Connection</span><br><span class="line">  file: File</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">  <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">    file.<span class="title function_ invoke__">write</span>(EOF); <span class="comment">// &lt;- 文件关闭前写入终止符</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">conn</span> = <span class="title function_ invoke__">makeConnection</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">file</span> = <span class="title function_ invoke__">openFile</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">entity</span> = Entity &#123;</span><br><span class="line">  connection: &amp;conn, <span class="comment">// &lt;- 将 conn 借用给 entity</span></span><br><span class="line">  file: file <span class="comment">// &lt;- 将 file 所有权转移给 entity</span></span><br><span class="line">&#125; <span class="comment">// &lt;- 从此以后，file 将不可被访问</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">send</span>(entity: Entity) &#123;</span><br><span class="line">  <span class="comment">// logic</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// &lt;- 编译器会在此处插入释放 entity</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">send</span>(entity) <span class="comment">// &lt;- 将 entity 所有权移交给 send 函数</span></span><br><span class="line"><span class="comment">// &lt;- 编译器会在此处插入释放 conn</span></span><br><span class="line"><span class="comment">// &lt;- 因 entity 与 file 所有权已转移，此处不会重复释放 entity 与 file</span></span><br></pre></td></tr></table></figure>
<p>异步示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fn <span class="title function_">move_block</span><span class="params">()</span> -&gt; impl Future&lt;Output = ()&gt; &#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">my_string</span> <span class="operator">=</span> <span class="string">&quot;foo&quot;</span>.to_string();</span><br><span class="line">    async move &#123; <span class="comment">// &lt;- my_string 被 move 到此 block scope</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        println!(<span class="string">&quot;&#123;&#125;&quot;</span>, my_string); <span class="comment">// &lt;- my_string 在此处可以见</span></span><br><span class="line">        <span class="comment">// &lt;- 编译器将在此处插入 my_string drop 代码 </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// &lt;- my_string 将不再可见，本函数失去 my_string 所有权，不再插入 drop 代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>闭包捕获</strong>造成的资源逃逸与将引用赋值给<strong>类/结构体</strong>帮助资源逃逸在语言本质上是同一个问题，所以
Rust 可以用相同的方法来处理它们。</p>
<h1 id="总结">总结</h1>
<p>理论上来说垃圾回收器(<strong>Garbage
collector</strong>)无法解决资源安全问题，可能有人会认为：</p>
<blockquote>
<p>“给 Java 语言添加 <code>Destructor</code>
，这样开发者就可以在析构函数中实现资源释放逻辑，交给 GC
在回收内存时自动调用 <code>destory()/dispose()</code>
，问题不就解决了吗？“</p>
</blockquote>
<p>实际上这条路是走不通的，GC
根据算法不同，所参考的策略也不同，其收集(<code>collect</code>)/释放(<code>free</code>)动作必定会执行，但没有保证什么时候会执行，以什么顺序执行。因为考察
GC 性能指标时，更关注的是吞吐量而不是回收实时性，如果内存没有压力，GC
倾向于不回收。</p>
<p>这一行为可能会导致意想不到的后果，比如业务逻辑 A
结束时，文件资源对象的引用计数已经为零，通知下一个逻辑 B
可以处理此文件，而 B
尝试打开文件时却发现文件不完整，因为关闭文件的系统调用尚未被 GC
执行😵。</p>
<p>Rust
给出了一套完善的解决方案，它不仅解决了诸多内存安全问题，还顺带解决了资源安全问题。基于所有权机制和严格的编译器检查，强迫程序员写出资源安全的代码，仅需要程序员正确实现
<code>impl Drop for [...]</code> 。</p>
<p>我认为 Rust 实现的所有权与 RAII 是当下最完善的资源管理机制。</p>
<ul>
<li>与 <code>try-catch-finally</code>
相比，不需要在每次使用资源时，都格外小心是否双重释放(<code>double delete</code>
这在 Java 中是个很常见且令人头痛的问题)。</li>
<li>与 <code>ResourceMonad</code> 相比，不会产生资源逃逸。</li>
<li>是一门全新的语言，不像 C++ 一样有沉重的历史包袱。</li>
</ul>
<p>即使不使用 Rust
编码，依然可以借鉴它的思想，因为其语法本身就是资源管理的最佳实践，学习它可以帮助自己在其他语言中避开错误的写法。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2021/05/17/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/17/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-17 00:00:00" itemprop="dateCreated datePublished" datetime="2021-05-17T00:00:00+08:00">2021-05-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very
first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for
more info. If you get any problems when using Hexo, you can find the
answer in <a
target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or
you can ask me on <a
target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="create-a-new-post">Create a new post</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a
target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="run-server">Run server</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="generate-static-files">Generate static files</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a
target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="deploy-to-remote-sites">Deploy to remote sites</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a
target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2021/05/14/AC-AP-Enterprise-WiFi6-practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/14/AC-AP-Enterprise-WiFi6-practice/" class="post-title-link" itemprop="url">AC + AP Enterprise WiFi6 practice</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-14 12:09:40" itemprop="dateCreated datePublished" datetime="2021-05-14T12:09:40+08:00">2021-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2021/05/14/Rethink-CDC-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/14/Rethink-CDC-design/" class="post-title-link" itemprop="url">Rethink CDC system design</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-14 12:07:42" itemprop="dateCreated datePublished" datetime="2021-05-14T12:07:42+08:00">2021-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2021/05/14/Webhook-system-design-base-ZIO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/14/Webhook-system-design-base-ZIO/" class="post-title-link" itemprop="url">Webhook system design - base ZIO</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-14 09:42:33" itemprop="dateCreated datePublished" datetime="2021-05-14T09:42:33+08:00">2021-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="goals">Goals</h1>
<ul>
<li>Sending event message by http post</li>
<li>Recording success/error response from third-party reply.</li>
<li>It should re-send message after third-party reply error or
down.</li>
</ul>
<h1 id="features">Features</h1>
<ul>
<li>Delivery (HTTP POST)</li>
<li>Success / Error Record</li>
<li>Re-send in the case of third-party failure.</li>
<li>Run in multi-process environment (e.g. Kubernetes)</li>
<li>Metrics of backlog message</li>
<li>Policy of record automatic archive</li>
<li>Prevent sent too fequencly after massive event
generated.(throttle)</li>
</ul>
<h1 id="results">Results</h1>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://famer.me/2021/05/13/After-I-migrated-my-legacy-playframework-project-to-zio-what-I-learned-from-it/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ming yang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Space">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | My Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/13/After-I-migrated-my-legacy-playframework-project-to-zio-what-I-learned-from-it/" class="post-title-link" itemprop="url">After I migrated my legacy playframework project to zio, what I learned from it.</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-13 18:37:55" itemprop="dateCreated datePublished" datetime="2021-05-13T18:37:55+08:00">2021-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-06 20:29:54" itemprop="dateModified" datetime="2026-02-06T20:29:54+08:00">2026-02-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#foreword">Foreword</a></li>
<li><a href="#what-is-r">What is <code>R</code></a></li>
<li><a href="#what-are-the-problems-caused-by-di-tools">What are the
problems caused by DI tools?</a></li>
<li><a href="#current-situation">Current Situation</a></li>
<li><a href="#evolution-stage-1">Evolution Stage 1</a></li>
<li><a href="#evolution-stage-2">Evolution Stage 2</a></li>
<li><a href="#evolution-stage-3">Evolution Stage 3</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a></li>
</ul>
<h1 id="foreword">Foreword</h1>
<p>On April 17, 2020, I start a huge project to migrate the
<code>Future[T]</code> from legacy playframework project to
<code>ZIO</code>. Three months later, after tens of thousands of lines
of code modification, the migration was a complete success. In
September, I used this experience as the background to share in the
Chinese Scala Meetup community with the title <a
target="_blank" rel="noopener" href="https://www.slideshare.net/ssuser81d309/scala-meetup-248313493">"Introduction
to ZIO"</a>. In this share, I explained a fanatic imageation,
在这次分享中，我展望了一个美好的愿景，借由 <code>ZIO</code> 的类型参数
<code>R</code>
提供的抽象能力来实现代码的可移植性，和提高可测试性。但想在遗留项目中实现这个愿景并不容易，主要挑战来自遗留项目的代码耦合，和开发者的思维惯性。如今，这个愿景已经达成。我会在这篇
Post 中与你分享我的进化之路。</p>
<h1 id="what-is-r">What is <code>R</code></h1>
<blockquote>
<p>A <code>ZIO[R, E, A]</code> value is an immutable value that lazily
describes a workflow or job. The workflow requires some environment
<code>R</code>, and may fail with an error of type <code>E</code>, or
succeed with a value of type <code>A</code>.</p>
</blockquote>
<p>上面这段来自 <code>ZIO</code> 源码中的注释，其中指出 <code>R</code>
是 workflow
所需要的环境参数的类型。我们可以借助这个环境参数，来抽象出过程对环境的依赖。
这听起来非常像依赖注入，实际上确实如此。不同的是，常见的控制反转框架，注入入口都是业务逻辑类的成员以及其构造函数（比如：<a
target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-autowire">spring
autowire</a>、 <a target="_blank" rel="noopener" href="https://github.com/google/guice">guice</a>、 <a
target="_blank" rel="noopener" href="https://github.com/softwaremill/macwire">macwire</a> 等）；而
<code>ZIO</code> 的做法是，在运行时提供环对象的实例。</p>
<p>Example:</p>
<p>Spring <code>@Autowired</code>: Inject the dependent instance into
the object as a member of the class <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MovieRecommender</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CustomerPreferenceDao customerPreferenceDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MovieRecommender</span><span class="params">(CustomerPreferenceDao customerPreferenceDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.customerPreferenceDao = customerPreferenceDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> ZIO <code>R</code>:
Treat the instance as part of the environment, and provide it on demand
at runtime <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MovieRecommender</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recommend</span></span>(): <span class="type">ZIO</span>[<span class="type">CustomerPreferenceDao</span>, <span class="type">Throwable</span>, <span class="type">RecommendResult</span>] = &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="what-are-the-problems-caused-by-di-tools">What are the problems
caused by DI tools?</h1>
<p>I want to ask the reader a question: <strong><em>How much does it
cost to test a small feature in your software system?</em></strong></p>
<p>See: <a
target="_blank" rel="noopener" href="https://github.com/mingyang91/scala-meetup/tree/master/src/main/scala/meetup/di/legacy">Negative
example</a>。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> meetup.di.legacy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> meetup.di.legacy.member.&#123;<span class="type">Accountant</span>, <span class="type">Baker</span>, <span class="type">CandyMaker</span>, <span class="type">Cashier</span>, <span class="type">Decorator</span>, <span class="type">HunanChef</span>, <span class="type">Logistic</span>, <span class="type">Manager</span>, <span class="type">Security</span>, <span class="type">SichuanChef</span>, <span class="type">Waiter</span>, <span class="type">Washer</span>&#125;</span><br><span class="line"><span class="keyword">import</span> meetup.di.legacy.tools.&#123;<span class="type">Mixer</span>, <span class="type">Oven</span>, <span class="type">PipingTip</span>, <span class="type">Turntable</span>&#125;</span><br><span class="line"><span class="keyword">import</span> meetup.di.legacy.utils.<span class="type">Demo</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">djx314</span> <span class="keyword">extends</span> <span class="title">App</span> <span class="keyword">with</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> mixer = <span class="keyword">new</span> <span class="type">Mixer</span>()</span><br><span class="line">  <span class="keyword">val</span> oven = <span class="keyword">new</span> <span class="type">Oven</span>()</span><br><span class="line">  <span class="keyword">val</span> pipingTip = <span class="keyword">new</span> <span class="type">PipingTip</span>()</span><br><span class="line">  <span class="keyword">val</span> turntable = <span class="keyword">new</span> <span class="type">Turntable</span>()</span><br><span class="line">  <span class="keyword">val</span> baker = <span class="keyword">new</span> <span class="type">Baker</span>(oven, mixer)</span><br><span class="line">  <span class="keyword">val</span> decorator = <span class="keyword">new</span> <span class="type">Decorator</span>(mixer, pipingTip, turntable)</span><br><span class="line">  <span class="keyword">val</span> candyMaker = <span class="keyword">new</span> <span class="type">CandyMaker</span></span><br><span class="line">  <span class="keyword">val</span> scChef = <span class="keyword">new</span> <span class="type">SichuanChef</span></span><br><span class="line">  <span class="keyword">val</span> hnChef = <span class="keyword">new</span> <span class="type">HunanChef</span></span><br><span class="line">  <span class="keyword">val</span> cashier = <span class="keyword">new</span> <span class="type">Cashier</span></span><br><span class="line">  <span class="keyword">val</span> waiter = <span class="keyword">new</span> <span class="type">Waiter</span></span><br><span class="line">  <span class="keyword">val</span> washer = <span class="keyword">new</span> <span class="type">Washer</span></span><br><span class="line">  <span class="keyword">val</span> logistic = <span class="keyword">new</span> <span class="type">Logistic</span></span><br><span class="line">  <span class="keyword">val</span> security = <span class="keyword">new</span> <span class="type">Security</span></span><br><span class="line">  <span class="keyword">val</span> accountant = <span class="keyword">new</span> <span class="type">Accountant</span></span><br><span class="line">  <span class="keyword">val</span> manager = <span class="keyword">new</span> <span class="type">Manager</span></span><br><span class="line">  <span class="keyword">val</span> cs = <span class="keyword">new</span> <span class="type">CakeShop</span>(</span><br><span class="line">    baker, decorator, candyMaker,</span><br><span class="line">    scChef, hnChef, cashier,</span><br><span class="line">    waiter, washer, logistic,</span><br><span class="line">    security, accountant, manager</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  cs.simpleCake()</span><br><span class="line">    .onComplete(println)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I just want to test a small part of the functions, why do I need to
construct all dependent instances. Why do I have to do so much
preparation to test this simple function. Because it belongs to the
method of the class, and this class has too many construction
parameters, these construction parameters are unnecessary for the
function we want to test</p>
<p>若想让工程代码最大程度上可移植、可测试，一个简单易行的方法是：<strong><em>不要在类中编写与对象无关(no
use <code>this</code>)的函数，将他们移动到 <code>object</code> 中(in
java: mark method
<code>static</code>)。</em></strong>同时，编写引用透明的代码对达成这一目标有正面作用。</p>
<p>但是，在遗留项目中实现这一点有些困难,
因为大多数开发者都把依赖注入框架错用了，就像上面的反面教材一样。Even
Spring contributors made the same mistake. See: <a
target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-petclinic/blob/main/src/main/java/org/springframework/samples/petclinic/owner/OwnerController.java">Spring's
sample project</a></p>
<p>Too many irrelevant dependencies have brought huge obstacles to the
portability of codes, turning them into ad hoc codes that are difficult
to test.</p>
<p>The whole system is like a balls made up of strings and knots. <img
src="/images/mass-string-ball.jpeg"
alt="Software System like a ball made up of strings and knots" /></p>
<h1 id="current-situation">Current Situation</h1>
<p>社区中的方案... zio layer 每次 unsafeRun
都会重新生成，这很纯函数式，但这不适合 web 服务。例如连接池</p>
<p>遇到的问题 * 连接池 * 信号量</p>
<p>所以，我只能自己尝试：</p>
<h1 id="evolution-stage-1">Evolution Stage 1</h1>
<p>ZioController + PlayRunner</p>
<h1 id="evolution-stage-2">Evolution Stage 2</h1>
<p>ZController + ZRunner <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">```scala</span><br></pre></td></tr></table></figure></p>
<h1 id="evolution-stage-3">Evolution Stage 3</h1>
<p>ZController + Runtime.Managed <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">ZController</span>[<span class="type">Z</span>, <span class="type">R</span>[_], <span class="title">B</span>] </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">runtime</span></span>: <span class="type">Runtime</span>.<span class="type">Managed</span>[<span class="type">Z</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionBuilderOps</span>(<span class="params">actionBuilder: <span class="type">ActionBuilder</span>[<span class="type">R</span>, <span class="type">B</span>]</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">zio</span></span>[<span class="type">E</span>](zioActionBody: =&gt; <span class="type">ZIO</span>[<span class="type">Z</span>, <span class="type">Throwable</span>, <span class="type">Result</span>]): <span class="type">Action</span>[<span class="type">AnyContent</span>] = actionBuilder.async &#123;</span><br><span class="line">      runtime.unsafeRunToFuture(zioActionBody.resurrect)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">zio</span></span>[<span class="type">E</span>](zioActionBody: <span class="type">R</span>[<span class="type">B</span>] =&gt; <span class="type">ZIO</span>[<span class="type">Z</span>, <span class="type">Throwable</span>, <span class="type">Result</span>]): <span class="type">Action</span>[<span class="type">B</span>] = actionBuilder.async &#123; req =&gt;</span><br><span class="line">      runtime.unsafeRunToFuture(zioActionBody(req).resurrect)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A runtime that can be shutdown to release resources allocated to it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Managed</span>[+<span class="type">R</span>] <span class="keyword">extends</span> <span class="title">Runtime</span>[<span class="type">R</span>] </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure>
<p>使用起来</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ExampleController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span>(<span class="params">endpoint: <span class="type">String</span></span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">flow</span></span>(endpoint: <span class="type">String</span>, url: <span class="type">String</span>, body: <span class="type">RawBuffer</span>): <span class="type">ZIO</span>[<span class="type">Has</span>[<span class="type">WSClient</span>], <span class="type">Throwable</span>, <span class="type">String</span>] = ???</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleController</span>(<span class="params">cc: <span class="type">ControllerComponents</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                        config: <span class="type">ExampleController</span>.<span class="type">Config</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                        <span class="type">MAction</span>: <span class="type">MemberAction</span></span>)</span></span><br><span class="line">                       (<span class="keyword">implicit</span> <span class="keyword">val</span> runtime: <span class="type">Runtime</span>.<span class="type">Managed</span>[<span class="type">Has</span>[<span class="type">WSClient</span>]],</span><br><span class="line">                        <span class="keyword">val</span> ec: <span class="type">ExecutionContext</span>)</span><br><span class="line">  <span class="keyword">extends</span> <span class="type">AbstractController</span>(cc) <span class="keyword">with</span> <span class="type">ZController</span>[<span class="type">Has</span>[<span class="type">WSClient</span>], <span class="type">MemberRequest</span>, <span class="type">RawBuffer</span>] &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle</span></span>(url: <span class="type">String</span>): <span class="type">Action</span>[<span class="type">RawBuffer</span>] = <span class="type">MAction</span>(parse.raw) zio &#123; request: <span class="type">MemberRequest</span>[<span class="type">RawBuffer</span>] =&gt;</span><br><span class="line">    flow(config.endpoint, url, request.body)</span><br><span class="line">      .map(name =&gt; <span class="type">Ok</span>(name))</span><br><span class="line">      .mapError(e =&gt; <span class="type">InternalServerError</span>(<span class="string">&quot;Oh no!\n&quot;</span> + e.getMessage))</span><br><span class="line">      .merge</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="conclusion">Conclusion</h1>
<h1 id="references">References</h1>
<p><a
target="_blank" rel="noopener" href="https://www.markopapic.com/dependency-injection-tradeoffs/">Dependency
Injection Trade-offs</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ming yang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js","integrity":"sha256-e0o3JYsdjqKajf9eOe22FhioYSz9WofRY4dLKo3F6do="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
